function distance(a,t,h,M){var n=Math.PI*a/180,s=Math.PI*h/180,c=t-M,o=Math.PI*c/180,i=Math.sin(n)*Math.sin(s)+Math.cos(n)*Math.cos(s)*Math.cos(o);return i=Math.acos(i),i=180*i/Math.PI,i=60*i*1.1515,i=Math.round(i)}
angular.module("mapsApp",[]).controller("MapCtrl",["$scope","MapSvc",function(e,r){var t=37.09024,o=-95.712891,n=new google.maps.LatLng(t,o),a={zoom:4,center:n},s=[],l=[getByName(serverLocs,"Atlanta"),getByName(serverLocs,"Dallas"),getByName(serverLocs,"Los Angeles"),getByName(serverLocs,"Seattle"),getByName(serverLocs,"Chicago"),getByName(serverLocs,"New York"),getByName(serverLocs,"Washington DC"),getByName(serverLocs,"Atlanta"),getByName(serverLocs,"Miami"),getByName(serverLocs,"Dallas")];e.map=new google.maps.Map(document.getElementById("map"),a),e.geocoder=new google.maps.Geocoder;for(var i=0;i<serverLocs.length;i++)createMarker(serverLocs[i],e.map);for(var i=0;i<l.length-1;i++)networkline=createNetworkLine(l[i],l[i+1],"red"),networkline.setMap(e.map),placeDistance(e.map,l[i],l[i+1]);e.pair={},e.serverLocs=serverLocs,e.clientServerPairs=r.getPairs(),e.onSubmit=function(){s=geocodeAddress(e.geocoder,e.map,l,e.pair.client,e.pair.server,s),console.log("currentClientToServerRoute: ",s),r.addPair(e.pair),e.pair={}},e.viewPair=function(e){r.viewPair(e),console.log("currentClientToServerRoute: ",s)},e.deletePair=function(e){r.deletePair(e)}}]).service("MapSvc",function(){var e=[];this.addPair=function(r){e.push({client:r.client,server:r.server});var t=JSON.stringify(e);localStorage.setItem("clientServerPairs",t)},this.getPairs=function(){var r=localStorage.getItem("clientServerPairs");return e=JSON.parse(r)||e},this.viewPair=function(e){console.log("i was clicked!")},this.deletePair=function(r){e.splice(r,1);var t=JSON.stringify(e);localStorage.setItem("clientServerPairs",t)}});var getByName=function(e,r){for(var t=0;t<e.length;t++)if(e[t].name==r)return e[t]},createMarker=function(e,r){var t=new google.maps.InfoWindow,o=new google.maps.Marker({position:{lat:e.lat,lng:e.lng},map:r,title:e.name});o.content='<div class="infoWindowContent">'+e.address+"</div>",google.maps.event.addListener(o,"click",function(){t.setContent("<h2>"+o.title+"</h2>"+o.content),t.open(r,o)})},createNetworkLine=function(e,r,t){var o=(new google.maps.LatLng(e.lat,e.lng),new google.maps.LatLng(r.lat,r.lng),[{lat:e.lat,lng:e.lng},{lat:r.lat,lng:r.lng}]),n=new google.maps.Polyline({path:o,geodesic:!0,strokeColor:t,strokeOpacity:1,strokeWeight:2});return n},placeDistance=function(e,r,t){var o=new google.maps.LatLng(r.lat,r.lng),n=new google.maps.LatLng(t.lat,t.lng);inBetween=google.maps.geometry.spherical.interpolate(o,n,.5);var a=distance(r.lat,r.lng,t.lat,t.lng),s=new MapLabel({text:a+" mi",position:inBetween,map:e,fontSize:20});s.set("position",inBetween)},geocodeAddress=function(e,r,t,o,n,a){e.geocode({address:o},function(e,s){return s===google.maps.GeocoderStatus.OK?(clientLoc={lat:e[0].geometry.location.lat(),lng:e[0].geometry.location.lng(),address:o},createMarker(clientLoc,r),closestServer=findClosestServer(clientLoc.lat,clientLoc.lng),clientToServerLine=createNetworkLine(clientLoc,closestServer,"green"),a.push(clientToServerLine),clientToServerLine.setMap(r),closestServer.name!=n&&(a=createRouteServerToServer(closestServer.name,n,r,t,a)),console.log("currentClientToServerRoute: ",a),a):void alert("Geocode was not successful for the following reason: "+s)})},findClosestServer=function(e,r){for(var t={},o=[],n=0,t={},a=0;a<serverLocs.length;a++){var s=serverLocs[a];o[a]=distance(e,r,s.lat,s.lng),0==a?(n=o[a],t=s):o[a]<n&&(n=o[a],t=serverLocs[a])}return t},createRouteServerToServer=function(e,r,t,o,n){for(var a=!1,s=0,l={},i={},c=0;c<o.length;c++)if(e==o[c].name){l=o[c];for(var g=c+1;g<o.length;g++){if(i=o[g],s+=distance(l.lat,l.lng,i.lat,i.lng),serverToServerLine=createNetworkLine(l,i,"green"),serverToServerLine.setMap(t),n.push(serverToServerLine),r==o[g].name){a=!0;break}l=i,a||g!=o.length-1||(g=0)}}return console.log("and the total distance is... ",s),n};
function MapLabel(t){this.set("fontFamily","sans-serif"),this.set("fontSize",12),this.set("fontColor","#000000"),this.set("strokeWeight",4),this.set("strokeColor","#ffffff"),this.set("align","center"),this.set("zIndex",1e3),this.setValues(t)}MapLabel.prototype=new google.maps.OverlayView,window.MapLabel=MapLabel,MapLabel.prototype.changed=function(t){switch(t){case"fontFamily":case"fontSize":case"fontColor":case"strokeWeight":case"strokeColor":case"align":case"text":return this.drawCanvas_();case"maxZoom":case"minZoom":case"position":return this.draw()}},MapLabel.prototype.drawCanvas_=function(){var t=this.canvas_;if(t){var e=t.style;e.zIndex=this.get("zIndex");var a=t.getContext("2d");a.clearRect(0,0,t.width,t.height),a.strokeStyle=this.get("strokeColor"),a.fillStyle=this.get("fontColor"),a.font=this.get("fontSize")+"px "+this.get("fontFamily");var o=Number(this.get("strokeWeight")),i=this.get("text");if(i){o&&(a.lineWidth=o,a.strokeText(i,o,o)),a.fillText(i,o,o);var s=a.measureText(i),n=s.width+o;e.marginLeft=this.getMarginLeft_(n)+"px",e.marginTop="-0.4em"}}},MapLabel.prototype.onAdd=function(){var t=this.canvas_=document.createElement("canvas"),e=t.style;e.position="absolute";var a=t.getContext("2d");a.lineJoin="round",a.textBaseline="top",this.drawCanvas_();var o=this.getPanes();o&&o.mapPane.appendChild(t)},MapLabel.prototype.onAdd=MapLabel.prototype.onAdd,MapLabel.prototype.getMarginLeft_=function(t){switch(this.get("align")){case"left":return 0;case"right":return-t}return t/-2},MapLabel.prototype.draw=function(){var t=this.getProjection();if(t&&this.canvas_){var e=this.get("position");if(e){var a=t.fromLatLngToDivPixel(e),o=this.canvas_.style;o.top=a.y+"px",o.left=a.x+"px",o.visibility=this.getVisible_()}}},MapLabel.prototype.draw=MapLabel.prototype.draw,MapLabel.prototype.getVisible_=function(){var t=this.get("minZoom"),e=this.get("maxZoom");if(void 0===t&&void 0===e)return"";var a=this.getMap();if(!a)return"";var o=a.getZoom();return t>o||o>e?"hidden":""},MapLabel.prototype.onRemove=function(){var t=this.canvas_;t&&t.parentNode&&t.parentNode.removeChild(t)},MapLabel.prototype.onRemove=MapLabel.prototype.onRemove;
var serverLocs=[{name:"New York",address:"111 8th Ave, New York, NY 10011",lat:40.741355,lng:-74.003203},{name:"Washington DC",address:"21715 Filigree Ct., Ashburn VA 20147",lat:39.016363,lng:-77.459022},{name:"Atlanta",address:"56 Marietta St., Atlanta, GA 30303",lat:33.755456,lng:-84.39153},{name:"Dallas",address:"1950 Stemmons Frwy",lat:32.799852,lng:-96.820433},{name:"Los Angeles",address:"624 S. Grand Ave, Los Angeles, CA 90017",lat:34.047908,lng:-118.255536},{name:"Chicago",address:"350 E Cermak Rd, Chicago, IL 60616",lat:41.854159,lng:-87.619014},{name:"Seattle",address:"2001 Sixth Ave, Seattle WA, 98121",lat:47.6143,lng:-122.3388},{name:"Miami",address:"50 Northeast 9th Street, Miami, FL",lat:25.782648,lng:-80.193157}];