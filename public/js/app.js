function distance(a,t,h,M){var n=Math.PI*a/180,s=Math.PI*h/180,c=t-M,o=Math.PI*c/180,i=Math.sin(n)*Math.sin(s)+Math.cos(n)*Math.cos(s)*Math.cos(o);return i=Math.acos(i),i=180*i/Math.PI,i=60*i*1.1515,i=Math.round(i)}
angular.module("mapsApp",[]).controller("MapCtrl",["$scope","$http","MapSvc",function(e,t,r){var a=function(){e.clientServerPairs=r.getPairs(),e.pair={}},i={},n=37.09024,s=-95.712891,l=new google.maps.LatLng(n,s),o={zoom:4,center:l},c="https://maps.googleapis.com/maps/api/geocode/json",p="AIzaSyAH9qcwj9QQxgs9xEZylRLUVHO8_aojLEY",v=[{featureType:"landscape",stylers:[{saturation:-100},{lightness:65},{visibility:"on"}]},{featureType:"poi",stylers:[{saturation:-100},{lightness:51},{visibility:"simplified"}]},{featureType:"road.highway",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"road.arterial",stylers:[{saturation:-100},{lightness:30},{visibility:"on"}]},{featureType:"road.local",stylers:[{saturation:-100},{lightness:40},{visibility:"on"}]},{featureType:"transit",stylers:[{saturation:-100},{visibility:"simplified"}]},{featureType:"administrative.province",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"labels",stylers:[{visibility:"on"},{lightness:-25},{saturation:-100}]},{featureType:"water",elementType:"geometry",stylers:[{hue:"#c7d6dd"},{lightness:-25},{saturation:-97}]}],g=[getByName(serverLocs,"Atlanta"),getByName(serverLocs,"Dallas"),getByName(serverLocs,"Los Angeles"),getByName(serverLocs,"Seattle"),getByName(serverLocs,"Chicago"),getByName(serverLocs,"New York"),getByName(serverLocs,"Washington DC"),getByName(serverLocs,"Atlanta"),getByName(serverLocs,"Miami"),getByName(serverLocs,"Dallas")],u=g.slice();u.reverse();var m=g.slice(0,8),d=m.slice();d.reverse();var f=[g,u,m,d];e.map=new google.maps.Map(document.getElementById("map"),o),e.map.set("styles",v);for(var y=0;y<serverLocs.length;y++)createMarker(serverLocs[y],e.map);i=createNetworkLine(g,"#FF1A1A",2),i.setMap(e.map);for(var L=0;L<g.length-1;L++)placeDistance(e.map,g[L],g[L+1]);e.pair={},e.serverLocs=serverLocs,e.clientServerPairs=r.getPairs(),e.clientMarkers=[],e.clientToServerLines=[],e.onSubmit=function(){var i={},n={},s=[],l={},o=[],v={},g=0;t({method:"GET",url:c+"?address="+e.pair.client+"&key="+p}).then(function(t){i={lat:t.data.results[0].geometry.location.lat,lng:t.data.results[0].geometry.location.lng,name:"Client Location",address:t.data.results[0].formatted_address},e.pair.client=t.data.results[0].formatted_address,null!=e.clientMarker&&e.clientMarker.setMap(null),null!=e.clientToServerLine&&e.clientToServerLine.setMap(null),e.pair.clientLoc={lat:i.lat,lng:i.lng,name:"Client Location",address:t.data.results[0].formatted_address},e.clientMarker=createMarker(i,e.map),s.push(i),l=findClosestServer(i.lat,i.lng),n=l.closestServer,g+=l.dist,s.push(n),n.name!=e.pair.server&&(v=createRouteServerToServer(n.name,e.pair.server,f),o=v.pts,g+=v.dist,s=s.concat(o)),e.pair.dist=g,e.pair.clientToServerPath=s,e.clientToServerLine=createNetworkLine(s,"#0024F2",3),e.clientToServerLine.setMap(e.map),r.addPair(e.pair),a()},function(e){return e.status(200).json(data)})},e.viewPair=function(t){var a=r.viewPair(t);null!=e.clientMarker&&e.clientMarker.setMap(null),null!=e.clientToServerLine&&e.clientToServerLine.setMap(null),e.clientMarker=createMarker(a.clientLoc,e.map),e.clientToServerLine=createNetworkLine(a.clientToServerPath,"#0024F2",3),e.clientToServerLine.setMap(e.map)},e.deletePair=function(e){r.viewPair(e);r.deletePair(e),a()},e.clearMap=function(){null!=e.clientMarker&&e.clientMarker.setMap(null),null!=e.clientToServerLine&&e.clientToServerLine.setMap(null)}}]).service("MapSvc",function(){var e=[];this.addPair=function(t){e.push({client:t.client,server:t.server,clientLoc:t.clientLoc,clientToServerPath:t.clientToServerPath,dist:t.dist});var r=JSON.stringify(e);localStorage.setItem("clientServerPairs",r)},this.getPairs=function(){var t=localStorage.getItem("clientServerPairs");return e=JSON.parse(t)||e},this.viewPair=function(t){var r=localStorage.getItem("clientServerPairs",r);return e=JSON.parse(r),e[t]},this.deletePair=function(t){e.splice(t,1);var r=JSON.stringify(e);localStorage.setItem("clientServerPairs",r)}});var getByName=function(e,t){for(var r=0;r<e.length;r++)if(e[r].name===t)return e[r]},createMarker=function(e,t){var r=new google.maps.InfoWindow,a="";a="Client Location"===e.name?"assets/img/location-pin-blue.png":"assets/img/location-pin-red.png";var i=new google.maps.Marker({position:{lat:e.lat,lng:e.lng},map:t,title:e.name,icon:a});return i.content='<div class="infoWindowContent">'+e.address+"</div>",google.maps.event.addListener(i,"click",function(){r.setContent("<h2>"+i.title+"</h2>"+i.content),r.open(t,i)}),i},createNetworkLine=function(e,t,r){for(var a=[],i=0;i<e.length;i++)a.push({lat:e[i].lat,lng:e[i].lng});var n=new google.maps.Polyline({path:a,geodesic:!0,strokeColor:t,strokeOpacity:1,strokeWeight:r});return n},placeDistance=function(e,t,r){var a={},i=new google.maps.LatLng(t.lat,t.lng),n=new google.maps.LatLng(r.lat,r.lng);a=google.maps.geometry.spherical.interpolate(i,n,.5);var s=distance(t.lat,t.lng,r.lat,r.lng),l=new MapLabel({text:s+" mi",position:a,map:e,fontSize:20,zIndex:100});l.set("position",a)},findClosestServer=function(e,t){for(var r={},a=[],i=0,r={},n={},s=0;s<serverLocs.length;s++){var l=serverLocs[s];a[s]=distance(e,t,l.lat,l.lng),0==s?(i=a[s],r=l):a[s]<i&&(i=a[s],r=serverLocs[s])}return n={dist:i,closestServer:r}},createRouteServerToServer=function(e,t,r){var a=!1,i=0,n={},s={},l=[],o={},c=[],p=[],v=0,g=0,u=r.slice();"Miami"!=e&&"Miami"!=t||u.splice(2,2);for(var m=0;m<u.length;m++){p=u[m];for(var d=0;d<p.length;d++)if(e===p[d].name){n=p[d];for(var f=d+1;f<p.length;f++){if(s=p[f],i+=distance(n.lat,n.lng,s.lat,s.lng),l.push(n),t===p[f].name){a=!0;break}n=s,a||f!==p.length-1||(f=0)}}l.push(s),o={pts:l.slice(),dist:i},c.push(o),i=0,l=[],n={},s={},a=!1}v=c[0].dist;for(var y=0;y<c.length;y++)c[y].dist<v&&(v=c[y].dist,g=y);return c[g]};
function MapLabel(t){this.set("fontFamily","sans-serif"),this.set("fontSize",12),this.set("fontColor","#000000"),this.set("strokeWeight",4),this.set("strokeColor","#ffffff"),this.set("align","center"),this.set("zIndex",1e3),this.setValues(t)}MapLabel.prototype=new google.maps.OverlayView,window.MapLabel=MapLabel,MapLabel.prototype.changed=function(t){switch(t){case"fontFamily":case"fontSize":case"fontColor":case"strokeWeight":case"strokeColor":case"align":case"text":return this.drawCanvas_();case"maxZoom":case"minZoom":case"position":return this.draw()}},MapLabel.prototype.drawCanvas_=function(){var t=this.canvas_;if(t){var e=t.style;e.zIndex=this.get("zIndex");var a=t.getContext("2d");a.clearRect(0,0,t.width,t.height),a.strokeStyle=this.get("strokeColor"),a.fillStyle=this.get("fontColor"),a.font=this.get("fontSize")+"px "+this.get("fontFamily");var o=Number(this.get("strokeWeight")),i=this.get("text");if(i){o&&(a.lineWidth=o,a.strokeText(i,o,o)),a.fillText(i,o,o);var s=a.measureText(i),n=s.width+o;e.marginLeft=this.getMarginLeft_(n)+"px",e.marginTop="-0.4em"}}},MapLabel.prototype.onAdd=function(){var t=this.canvas_=document.createElement("canvas"),e=t.style;e.position="absolute";var a=t.getContext("2d");a.lineJoin="round",a.textBaseline="top",this.drawCanvas_();var o=this.getPanes();o&&o.mapPane.appendChild(t)},MapLabel.prototype.onAdd=MapLabel.prototype.onAdd,MapLabel.prototype.getMarginLeft_=function(t){switch(this.get("align")){case"left":return 0;case"right":return-t}return t/-2},MapLabel.prototype.draw=function(){var t=this.getProjection();if(t&&this.canvas_){var e=this.get("position");if(e){var a=t.fromLatLngToDivPixel(e),o=this.canvas_.style;o.top=a.y+"px",o.left=a.x+"px",o.visibility=this.getVisible_()}}},MapLabel.prototype.draw=MapLabel.prototype.draw,MapLabel.prototype.getVisible_=function(){var t=this.get("minZoom"),e=this.get("maxZoom");if(void 0===t&&void 0===e)return"";var a=this.getMap();if(!a)return"";var o=a.getZoom();return t>o||o>e?"hidden":""},MapLabel.prototype.onRemove=function(){var t=this.canvas_;t&&t.parentNode&&t.parentNode.removeChild(t)},MapLabel.prototype.onRemove=MapLabel.prototype.onRemove;
var serverLocs=[{name:"New York",address:"111 8th Ave, New York, NY 10011",lat:40.741355,lng:-74.003203},{name:"Washington DC",address:"21715 Filigree Ct., Ashburn VA 20147",lat:39.016363,lng:-77.459022},{name:"Atlanta",address:"56 Marietta St., Atlanta, GA 30303",lat:33.755456,lng:-84.39153},{name:"Dallas",address:"1950 Stemmons Frwy",lat:32.799852,lng:-96.820433},{name:"Los Angeles",address:"624 S. Grand Ave, Los Angeles, CA 90017",lat:34.047908,lng:-118.255536},{name:"Chicago",address:"350 E Cermak Rd, Chicago, IL 60616",lat:41.854159,lng:-87.619014},{name:"Seattle",address:"2001 Sixth Ave, Seattle WA, 98121",lat:47.6143,lng:-122.3388},{name:"Miami",address:"50 Northeast 9th Street, Miami, FL",lat:25.782648,lng:-80.193157}];